#!/bin/bash

set -e

BASEIMAGE="ubuntu:24.04"
IMAGE="u24"

SCRIPTPATH="$(dirname -- "$(realpath -- "$0")")"
IMAGE_DIR="$(realpath -- "$SCRIPTPATH/../images")"
CDC_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/cdc"
CDC_DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/cdc"
TOOLPATH="$(dirname -- "${SCRIPTPATH}")/tools"

# Not entirely clear which podman invocations are affected by this, but it seems to be needed to end up with the right owner of users files in the expanded roofs/
export PODMAN_USERNS="keep-id"

if [ -z "$USER" -o -z "$UID" -o -z "$LANG" ]; then
    echo "The following env variables must be set: USER, UID, LANG"
    exit 1
fi

rm -rf "$CDC_CONFIG_DIR/image-$IMAGE/installed"
rm -rf "$CDC_CONFIG_DIR/image-$IMAGE/build"
podman unshare -- rm -rf "$CDC_DATA_DIR/image-u24/rootfs"

mkdir -p "$CDC_CONFIG_DIR/image-$IMAGE/build/files"
cp -p /etc/timezone "$TOOLPATH/container/entrypoint" "$TOOLPATH/container/en_SE.locale" "$CDC_CONFIG_DIR/image-$IMAGE/build/files/."

FULLNAME="$(getent passwd rar | awk -F':' '{print $5}')"

# The sed 's/.utf8/.UTF-8/' fixes incorrectly specified locales from pre-GNOME 3.18 I think.
LOCALES="$(locale -a | grep -v "POSIX" | sed 's/.utf8/.UTF-8/' | tr '\n' ' ')"

# Handle that /etc/localtime both can be a symlink or a file, and re-do the symlink in the container
LOCALTIME=$(readlink /etc/localtime)
if [ -n "$LOCALTIME" ]; then
    TZ_LOCATION="${LOCALTIME##*/}"
    TZ_AREA="${LOCALTIME%/*}"
    TZ_AREA="${TZ_AREA##*/}"
    LOCALTIME_CMD="RUN ln -sf \"/usr/share/zoneinfo/${TZ_AREA}/${TZ_LOCATION}\" /etc/localtime"
else
    LOCALTIME_CMD="COPY files/localtime /etc/localtime"
    cp /etc/localtime "$CDC_CONFIG_DIR/image-$IMAGE/build/files/."
fi

podman pull "$BASEIMAGE"

# Base container image personalized for the specific user
cat > "$CDC_CONFIG_DIR/image-$IMAGE/build/Containerfile" <<EOF
FROM ubuntu:24.04
ARG USER_NAME \
USER_UID \
USER_GID \
USER_FULLNAME \
BUILD_UID \
BUILD_GID
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update -y && apt-get -y install --reinstall ca-certificates locales tzdata python3-minimal python3-watchdog curl && apt-get clean autoclean -y && rm -rf /var/tmp/* /var/lib/apt/lists/* /tmp/*
RUN set -eux; \
    if getent passwd "\${USER_UID}" >/dev/null; then \
      olduser="\$(getent passwd "\${USER_UID}" | cut -d: -f1)"; \
      userdel -r "\${olduser}"; \
    fi; \
    if getent group "\${USER_GID}" >/dev/null; then \
      oldgroup="\$(getent group "\${USER_GID}" | cut -d: -f1)"; \
      groupdel "\${oldgroup}"; \
    fi; \
    groupadd -g "\${USER_GID}" \${USER_NAME}; \
    useradd -M -u "\${USER_UID}" -g "\${USER_GID}" -c "\${USER_FULLNAME}" -s /bin/bash \${USER_NAME}; \
    groupadd -g "\${BUILD_GID}" build && useradd -m -u "\${BUILD_UID}" -g "\${BUILD_GID}" -c "Build user" build;
COPY files/entrypoint /cdc/entrypoint
COPY files/en_SE.locale "/usr/share/i18n/locales/en_SE"
RUN localedef -i en_SE -f UTF-8 en_SE.UTF-8 && echo "# en_SE.UTF-8 UTF-8" >> "/etc/locale.gen" && echo "en_SE.UTF-8 UTF-8" >> "/usr/share/i18n/SUPPORTED" && locale-gen ${LOCALES} && update-locale "LANG=$LANG";
RUN mkdir -p /run/user/\${USER_UID} && chown "\${USER_NAME}:\${USER_NAME}" "/run/user/\${USER_UID}" && chmod 700 "/run/user/\${USER_UID}"
USER \${USER_NAME}
CMD ["bash"]
EOF

(
  cd "$CDC_CONFIG_DIR/image-$IMAGE/build"
  podman build --squash --label="cdc-build-image-${IMAGE}" --build-arg USER_NAME="${USER}" --build-arg USER_FULLNAME="${FULLNAME}" --build-arg USER_UID="$(id -u)" --build-arg USER_GID="$(id -g)" --build-arg BUILD_UID="$(( $(id -u) + 1000 ))" --build-arg BUILD_GID="$(( $(id -g) + 1000 ))" -t "cdc-${IMAGE}" .
  podman image prune -f --filter "label=cdc-build-image-${IMAGE}"
)

# We expand the rootfs into a directory instead, to avoid costly operations on full image files (userns=keep-id needs chown of every file...)
IMGDIR="$CDC_DATA_DIR/image-u24"
mkdir -p "${IMGDIR}/rootfs"
mkdir -p "${IMGDIR}/opt"
podman unshare -- sh -c "cid=$(podman create "cdc-$IMAGE") && podman export \"\$cid\" | tar -C \"${IMGDIR}/rootfs\" -xpf - --numeric-owner --xattrs --acls && podman rm \"\$cid\""

# Continued customization in the roofs on top of base image

# This used to be necessary for e.g., steam to use bwrap, but maybe
#   chmod +s /usr/bin/bwrap;
# but maybe this workaround for other issues fixed it?
#   setpriv --ambient-caps '-all' <steam command>

SETUP_SCRIPT="
export DEBIAN_FRONTEND=noninteractive;
dpkg --add-architecture i386 && apt-get update && apt-get -y dist-upgrade && apt-get -y clean;
"

# Google Chrome is necessary to support installation of progressive-web-apps (PWA)
SETUP_SCRIPT="${SETUP_SCRIPT}curl -LO https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && apt -y install ./google-chrome-stable_current_amd64.deb && rm -f google-chrome-stable_current_amd64.deb;"

SETUP_SCRIPT="${SETUP_SCRIPT}apt-get clean autoclean -y && apt-get autoremove -y;"

echo "Setup script"
echo "$SETUP_SCRIPT"

podman run --volume "${IMGDIR}/opt:/opt:rw" -u root --userns="keep-id" --rm --rootfs "${IMGDIR}/rootfs" bash -c "${SETUP_SCRIPT}"

echo "Test run of new container."
#time podman run --rm -w "/home/$USER" --user="$USER" --shm-size=1G --cap-drop=ALL --read-only --read-only-tmpfs --userns="" --name "cdc_test_u24" cdc-u24 echo "Container finished."
#time podman run --rm -w "/home/$USER" --user="$USER" --shm-size=1G --cap-drop=ALL --read-only --read-only-tmpfs --userns="keep-id" --name "cdc_test_u24" cdc-u24 echo "Container finished."

ROOTMOUNTS="--volume=${IMGDIR}/opt:/opt:ro"
for ROOTMOUNT in bin boot etc home sbin srv usr var; do
    ROOTMOUNTS="$ROOTMOUNTS --volume=$IMGDIR/rootfs/$ROOTMOUNT:/$ROOTMOUNT:ro"
done
time podman run --rm $ROOTMOUNTS -w "/home/$USER" --user="$USER" --shm-size=1G --cap-drop=ALL --read-only --read-only-tmpfs --tmpfs="/run" --userns="keep-id" --name "cdc_test_u24" cdc-u24 echo "Container finished."

echo "Running rootfs image first setup"
"${SCRIPTPATH}/cdc-image-first-setup"
