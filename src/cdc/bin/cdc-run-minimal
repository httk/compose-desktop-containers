#!/bin/bash

set -e

IMAGE="u24"

SCRIPTPATH="$(dirname -- "$(realpath -- "$0")")"
CDC_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/cdc"
CDC_DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/cdc"
TOOLPATH="$(dirname -- "${SCRIPTPATH}")/tools"
IMGDIR="$CDC_DATA_DIR/image-u24"

ROOTSCRIPT="$1"
shift 1

CONTAINER_ID=$(podman run \
       $ROOTMOUNTS \
       --rm \
       -w "/" \
       --hostname="cdc-$IMAGE" \
       --user=root \
       --name=wrap-upgrade-tmp \
       --volume="${TOOLPATH}/container:/cdc:ro" \
       --cap-drop=ALL \
       --cap-add=CAP_FOWNER \
       --cap-add=CAP_CHOWN \
       --cap-add=CAP_DAC_OVERRIDE \
       --cap-add=CAP_DAC_READ_SEARCH \
       --cap-add=CAP_SETUID \
       --cap-add=CAP_SETGID \
       --read-only=false \
       --read-only-tmpfs \
       --systemd=false \
       --security-opt=no-new-privileges \
       --userns=keep-id \
       -e LANG \
       -d \
       "cdc-${IMAGE}" /cdc/entrypoint "$1")

trap "podman stop \"${CONTAINER_ID}\"" exit

if [ -n "$1" ]; then
  podman exec \
       -w "/" \
       --user="$USER" \
       "$CONTAINER_ID" bash -c 'eval $@' bash "$@"
else
  podman exec \
       -it \
       -w "/" \
       --user="$USER" \
       -e LANG \
       "$CONTAINER_ID" /bin/bash
fi

echo "Stopping container"
podman stop "$CONTAINER_ID"
trap - exit

