#!/bin/bash

set -e

SCRIPTPATH="$(dirname -- "$(realpath -- "$0")")"
DEST_ABSPATH="$(cd -- "$DEST"; pwd -P)"
CDC_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/cdc"

if ! yq -r '."x-application"' compose.yaml > /dev/null 2>&1 || [ "$(yq -r '."x-application"' compose.yaml 2>/dev/null)" == "null" ]; then

    echo "=== Error dump ==="
    yq -r '."x-application"' compose.yaml && true
    echo "=================="

    echo "The file compose.yaml in this directory does not seem to be a valid compose-desktop-container yaml file."
    exit 1
fi

PODMAN_CONFIG=$(podman-compose -f compose.yaml config 2>/dev/null || true)

"$SCRIPTPATH/cdc-reinit"

if [ -z "$1" ]; then
    (
        export CDC_LAUNCH_SILENT=1
        "$SCRIPTPATH/cdc-launch" "redownload" || "$SCRIPTPATH/cdc-launch" "download" || true
        "$SCRIPTPATH/cdc-launch" "rebuild" || "$SCRIPTPATH/cdc-launch" "build" || true
        "$SCRIPTPATH/cdc-launch" "reinstall" || "$SCRIPTPATH/cdc-launch" "install" || true
    )
else
    (
        export CDC_LAUNCH_SILENT=1
        "$SCRIPTPATH/cdc-launch" "redownload" "$1" || "$SCRIPTPATH/cdc-launch" "download" "$1" || true
        "$SCRIPTPATH/cdc-launch" "rebuild" "$1" || "$SCRIPTPATH/cdc-launch" "build" "$1" || true
        "$SCRIPTPATH/cdc-launch" "reinstall" "$1" || "$SCRIPTPATH/cdc-launch" "install" "$1" || true
    )
fi

