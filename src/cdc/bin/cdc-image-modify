#!/bin/bash

set -e

IMAGE="u24"

SCRIPTPATH="$(dirname -- "$(realpath -- "$0")")"
CDC_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/cdc"
CDC_DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/cdc"
TOOLPATH="$(dirname -- "${SCRIPTPATH}")/tools"
IMGDIR="$CDC_DATA_DIR/image-u24"

ROOTMOUNTS="--volume=${IMGDIR}/opt:/opt:rw"
for ROOTMOUNT in bin boot etc home sbin srv usr var; do
    ROOTMOUNTS="$ROOTMOUNTS --volume=${IMGDIR}/rootfs/$ROOTMOUNT:/$ROOTMOUNT:rw"
done

echo "========================================================================="
echo "Opening a root shell to modify the root filesystem used with cdc-${IMAGE}"
echo "=========================================================================="
echo

podman rm -fi wrap-upgrade-tmp

CONTAINER_ID=$(podman run \
       $ROOTMOUNTS \
       --rm \
       -w "/" \
       --hostname="cdc-$IMAGE" \
       --user=root \
       --name=wrap-upgrade-tmp \
       --volume="${TOOLPATH}/container:/cdc:ro" \
       --cap-drop=ALL \
       --cap-add=CAP_FOWNER \
       --cap-add=CAP_CHOWN \
       --cap-add=CAP_DAC_OVERRIDE \
       --cap-add=CAP_DAC_READ_SEARCH \
       --cap-add=CAP_SETUID \
       --cap-add=CAP_SETGID \
       --read-only=false \
       --read-only-tmpfs \
       --systemd=false \
       --security-opt=no-new-privileges \
       --userns=keep-id \
       -e LANG \
       -d \
       --rootfs "${IMGDIR}/rootfs" /cdc/entrypoint)

trap "podman stop \"${CONTAINER_ID}\"" exit

if [ -n "$1" ]; then
  podman exec \
       -w "/" \
       --user=root \
       "$CONTAINER_ID" bash -c 'eval $@' bash "$@"
else
  podman exec \
       -it \
       -w "/" \
       --user=root \
       -e LANG \
       "$CONTAINER_ID" /bin/bash
fi

#podman exec \
#       -w "/" \
#       --user=root \
#       "$CONTAINER_ID" bash -c "mkdir -p /tmp/$USER && chown \"$USER:$USER\" \"/tmp/$USER\" && chmod 0700 \"/tmp/$USER\" && mkdir -p \"/tmp/$USER/run\" && chown \"$USER:$USER\" \"/tmp/$USER/run\" && chmod 0700 \"/tmp/$USER/run\""

echo "Stopping container"
podman stop "$CONTAINER_ID"
trap - exit

# Latest version uses read-write mounts from .local/share/cdc/image-u25/rootfs to preserve changes, no longer any need to update the underlying image
#
#echo "Commiting changes"
#podman commit --squash "$CONTAINER_ID" --change "USER=$USER" "cdc-${IMAGE}"
#podman rm -fi wrap-upgrade-tmp
#podman image prune -f
#(
#    cd "${IMGDIR}/rootfs"
#    podman unshare -- tar -cpf - . --numeric-owner | podman import - cdc-u24
#)
#echo "First run of new container (this may take a long time as podman may need to remap uid/gid manually)"

ROOTMOUNTS="--volume=${IMGDIR}/opt:/opt:ro"
for ROOTMOUNT in bin boot etc home sbin srv usr var; do
    ROOTMOUNTS="$ROOTMOUNTS --volume=$IMGDIR/rootfs/$ROOTMOUNT:/$ROOTMOUNT:ro"
done

echo "Test new container"
podman run --rm $ROOTMOUNTS -w "/home/$USER" --user="$USER" --shm-size=1G --cap-drop=ALL --read-only --read-only-tmpfs --userns=keep-id --name "cdc_test_u24" cdc-u24 echo "Container finished."
